<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Overlay Fléchettes - Live Score</title>
    <style>
        :root{
            --bg: rgba(0,0,0,0.0);
            --panel-bg: rgba(0,0,0,0.5);
            --text: #ffffff;
            --accent: #ffd166;
            --muted: rgba(255,255,255,0.8);
            --current-bg: rgba(255, 209, 102, 0.3);
        }
        html,body{
            margin:0;padding:0;background:var(--bg);height:100%;
            font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            -webkit-font-smoothing:antialiased;
        }
        .overlay {
            width:100%; height:100%;
            display:flex; align-items:center; justify-content:center;
            pointer-events:none;
        }
        table {
            width: 80%;
            max-width: 500px;
            pointer-events:auto;
            border-spacing: 0px;
        }
        .colors{
            background: #1c1b1b;
        }
        th, td {
            padding: 12px 16px;
            color: var(--text);
            text-align: left;
            border: 1px solid white !important;
        }
        th {
            border-bottom: 1px solid rgba(255,255,255,0.3);
            font-weight: 700;
        }

        tr.current {
            position: relative;
            border: 1px solid white !important;
        }

        tr.current::after {
            content: "";
            position: absolute;
            right: -16px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 15px solid red;

        }
        .score {
            font-weight: 800;
            color: #ca0018;
            font-size: 1.2em;
        }
        @media (max-width:640px){
            th, td { padding: 8px 10px; font-size: 14px; }
            .score { font-size: 1em; }
        }
        .status {
            position: absolute;
            left: 8px; top: 8px;
            background: rgba(0,0,0,0.45);
            padding: 6px 10px;
            color: var(--muted);
            border-radius: 8px;
            font-size: 12px;
        }

        /* Animation d’apparition du finish */


        .finish-anim {
            animation: slideIn 0.35s ease-out forwards;
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateX(100px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

    </style>
</head>
<body>
<div class="overlay">
    <table id="scoreboard">
        <thead>
        <tr>
            <th style="background-color: var(--bg) !important; border: 1px solid var(--bg);"></th>
            <th class="colors" id="tournament">Players</th>
            <th class="colors">Legs</th>
            <th class="colors">Scores</th>
        </tr>
        </thead>
        <tbody>
        <tr id="p1" class="">
            <td class="finish" id="p1_finish"></td>
            <td class="colors" id="p1_name">—</td>
            <td class="colors" id="p1_legs">—</td>
            <td class="score colors" id="p1_score">—</td>
        </tr>
        <tr id="p2" class="">
            <td class="finish" id="p2_finish"></td>
            <td class="colors" id="p2_name">—</td>
            <td class="colors" id="p2_legs">—</td>
            <td class="score colors" id="p2_score">—</td>
        </tr>
        <tr id="" class="">
            <td id="empty-cell" class="empty"></td>
            <td class="colors" id="title-compet" colspan="3"></td>
        </tr>
        </tbody>
    </table>
</div>
<div class="status" id="status" style="display: none">Initialisation…</div>

<script>
    const finishes = {
        "170": "T20 - T20 - Bull",
        "167": "T20 - T19 - Bull",
        "164": "T20 - T18 - Bull",
        "161": "T20 - T17 - Bull",
        "160": "T20 - T20 - D20",
        "158": "T20 - T20 - D19",
        "157": "T20 - T19 - D20",
        "156": "T20 - T20 - D18",
        "155": "T20 - T19 - D19",
        "154": "T20 - T18 - D20",
        "153": "T20 - T19 - D18",
        "152": "T20 - T20 - D16",
        "151": "T20 - T17 - D20",
        "150": "T20 - T18 - D18",
        "149": "T20 - T19 - D16",
        "148": "T20 - T16 - D20",
        "147": "T20 - T17 - D18",
        "146": "T20 - T18 - D16",
        "145": "T20 - T15 - D20",
        "144": "T20 - T20 - D12",
        "143": "T20 - T17 - D16",
        "142": "T20 - T14 - D20",
        "141": "T20 - T19 - D12",
        "140": "T20 - T20 - D10",
        "139": "T20 - T19 - D11",
        "138": "T20 - T18 - D12",
        "137": "T20 - T19 - D10",
        "136": "T20 - T20 - D8",
        "135": "T20 - T17 - D12",
        "134": "T20 - T14 - D16",
        "133": "T20 - T19 - D8",
        "132": "Bull - Bull - D16",
        "131": "T20 - T13 - D16",
        "130": "T20 - T18 - D8",
        "129": "T19 - T16 - D12",
        "128": "T18 - T14 - D16",
        "127": "T20 - T17 - D8",
        "126": "T19 - T19 - D6",
        "125": "Bull - T20 - D20",
        "124": "T20 - T16 - D8",
        "123": "T19 - T16 - D9",
        "122": "T18 - T18 - D7",
        "121": "T20 - T11 - D14",
        "120": "T20 - S20 - D20",
        "119": "T19 - T12 - D13",
        "118": "T20 - S18 - D20",
        "117": "T20 - S17 - D20",
        "116": "T20 - S16 - D20",
        "115": "T20 - S15 - D20",
        "114": "T20 - S14 - D20",
        "113": "T19 - S20 - D18",
        "112": "T20 - S12 - D20",
        "111": "T20 - S11 - D20",
        "110": "T20 - S10 - D20",
        "109": "T20 - S9 - D20",
        "108": "T20 - S16 - D16",
        "107": "T19 - S18 - D16",
        "106": "T20 - S10 - D18",
        "105": "T20 - S13 - D16",
        "104": "T18 - S18 - D16",
        "103": "T20 - S3 - D20",
        "102": "T20 - S10 - D16",
        "101": "T17 - S18 - D16",
        "100": "T20 - D20",
        "99": "T19 - S10 - D16",
        "98": "T20 - D19",
        "97": "T19 - D20",
        "96": "T20 - D18",
        "95": "T19 - D19",
        "94": "T18 - D20",
        "93": "T19 - D18",
        "92": "T20 - D16",
        "91": "T17 - D20",
        "90": "T20 - D15",
        "89": "T19 - D16",
        "88": "T20 - D14",
        "87": "T17 - D18",
        "86": "T18 - D16",
        "85": "T15 - D20",
        "84": "T20 - D12",
        "83": "T17 - D16",
        "82": "Bull - D16",
        "81": "T19 - D12",
        "80": "T20 - D10",
        "79": "T19 - D11",
        "78": "T18 - D12",
        "77": "T19 - D10",
        "76": "T20 - D8",
        "75": "T17 - D12",
        "74": "T14 - D16",
        "73": "T19 - D8",
        "72": "T16 - D12",
        "71": "T13 - D16",
        "70": "T20 - D5",
        "69": "T19 - D6",
        "68": "T20 - D4",
        "67": "T17 - D8",
        "66": "T10 - D18",
        "65": "T11 - D16",
        "64": "T16 - D8",
        "63": "T13 - D12",
        "62": "T10 - D16",
        "61": "T15 - D8",
        "60": "S20 - D20",
        "59": "S19 - D20",
        "58": "S18 - D20",
        "57": "S17 - D20",
        "56": "S16 - D20",
        "55": "S15 - D20",
        "54": "S18 - D18",
        "53": "S13 - D20",
        "52": "S20 - D16",
        "51": "S11 - D20",
        "50": "Bull",
        "49": "S17 - D16",
        "48": "S16 - D16",
        "47": "S15 - D16",
        "46": "S14 - D16",
        "45": "S13 - D16",
        "44": "S12 - D16",
        "43": "S3 - D20",
        "42": "S10 - D16",
        "41": "S1 - D20",
        "40": "D20",
        "39": "S7 - D16",
        "38": "D19",
        "37": "S5 -D16",
        "36": "D18",
        "35": "S3 -D16",
        "34": "D17",
        "33": "S1 - D16",
        "32": "D16",
        "31": "S15 - D8",
        "30": "D15",
        "29": "S13 - D8",
        "28": "D14",
        "27": "S11 - D8",
        "26": "D13",
        "25": "S9 - D8",
        "24": "D12",
        "23": "S7 - D8",
        "22": "D11",
        "21": "S5 - D8",
        "20": "D10",
        "19": "S3 - D8",
        "18": "D9",
        "17": "S1 - D8",
        "16": "D8",
        "15": "S7 - D4",
        "14": "D7",
        "13": "S5 - D4",
        "12": "D6",
        "11": "S3 - D4",
        "10": "D5",
        "9": "S1 - D4",
        "8": "D4",
        "7": "S3 - D2",
        "6": "D3",
        "5": "S1 - D2",
        "4": "D2",
        "3": "S1 - D1",
        "2": "D1"
    };
    const POLL_INTERVAL_MS = 2500;
    const statusEl = document.getElementById('status');
    const setStatus = t => statusEl.textContent = t;

    function updateOverlay(data) {
        document.getElementById('tournament').textContent = data.firstTo || 'Joueur';
        document.getElementById("title-compet").textContent = data.cleanTitle;

        const rows = [
            { row: document.getElementById('p1'), name: 'p1_name', score: 'p1_score', legs: 'p1_legs', val: { name: data.p1_name, score: data.p1_score, legs: data.p1_legs || '0' }, id: 'p1' },
            { row: document.getElementById('p2'), name: 'p2_name', score: 'p2_score', legs: 'p2_legs', val: { name: data.p2_name, score: data.p2_score, legs: data.p2_legs || '0' }, id: 'p2' }
        ];


        rows.forEach(r => {
            document.getElementById(r.name).textContent = r.val.name;
            document.getElementById(r.score).textContent = r.val.score;
            document.getElementById(r.legs).textContent = r.val.legs;

            // Highlight current player
            if (data.currentPlayer === r.val.name) {
                r.row.classList.add('current');
                updateFinish(r.id, r.val.score);
            } else {
                r.row.classList.remove('current');
                updateFinish(r.id, r.val.score)

            }
        });

    }

    function updateFinish(currentPlayerId, currentScore) {
        const finishCell = document.getElementById(currentPlayerId + "_finish");
        const titleCompet = document.getElementById("title-compet");
        if (!finishCell) return;

        const score = parseInt(currentScore, 10);
        const hasFinish = score <= 170 && score > 1 && finishes[score];

        if (hasFinish) {
            finishCell.textContent = finishes[score];
            finishCell.classList.add('current', 'finish-anim', 'colors');

            // Le titre prend moins de place → colspan = 3
            titleCompet.colSpan = 4;

        } else {
            finishCell.textContent = "";
            finishCell.classList.remove('current', 'finish-anim', 'colors');

            // Pas de finish → on recentre : colspan = 4
            titleCompet.colSpan = 3;
        }
    }



    async function poll() {
        try {
            setStatus('Récupération…');
            const res = await fetch('http://localhost:3000/scores', { cache: 'no-store' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();

            if(data.p1_name && data.p2_name){
                updateOverlay(data);
                setStatus('OK — mise à jour: ' + new Date().toLocaleTimeString());
            } else {
                setStatus('Scores non trouvés.');
            }

        } catch(err){
            console.error(err);
            setStatus('Erreur: ' + (err.message||err));
        } finally {
            setTimeout(poll, POLL_INTERVAL_MS);
        }
    }

    window.addEventListener('load', () => {
        setStatus('Démarrage…');
        poll();
    });
</script>
</body>
</html>
